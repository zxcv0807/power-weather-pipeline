name: Deploy to Naver Cloud

on:
  push:
    branches: [ main ]
    paths:
      - 'collectors/power/**'
      - 'requirements.txt'
      - '.github/workflows/deploy-naver.yml'

jobs:
  deploy:
    runs-on: [self-hosted, naver-cloud]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3 

      - name: Deploy Power Producer
        run: |
          # 1. Runner가 사용하는 작업 폴더에서 프로젝트 폴더로 이동
          cd /root/power-weather-pipeline
          
          # 2. 최신 코드 받기 (git pull)
          # (주의: 이 폴더가 git init이 되어 있어야 함.)
          git pull origin main
          
          # 3. 가상환경 활성화 & 설치
          source venv/bin/activate
          pip install -r requirements.txt
          
          # 4. 재시작
          pkill -f power_producer.py || true
          nohup python -u collectors/power/power_producer.py >> power.log 2>&1 &
          
          echo "✅ Naver Cloud Deployment Completed!"